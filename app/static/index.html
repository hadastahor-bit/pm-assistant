<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Planning Agent</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --s1: #3b82f6;
      --s2: #8b5cf6;
      --s3: #06b6d4;
      --s4: #f59e0b;
      --s5: #ef4444;
      --done: #10b981;
      --stage-color: #3b82f6;   /* updated dynamically with each stage */
      --bg: #f0f2f5;
      --surface: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --border: #e2e8f0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* â•â• CHAT VIEW â•â• */
    #chat-view {
      display: flex;
      width: 100%;
      max-width: 820px;
      height: 100vh;
      flex-direction: column;
      background: var(--surface);
      box-shadow: 0 4px 32px rgba(0,0,0,0.12);
    }

    #chat-header {
      background: #0f172a;
      color: #fff;
      padding: 16px 20px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-logo {
      width: 38px; height: 38px;
      background: var(--stage-color);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px;
      transition: background 0.4s ease;
      flex-shrink: 0;
    }
    .header-info h1 { font-size: 16px; font-weight: 700; }
    .header-info p  { font-size: 12px; color: rgba(255,255,255,0.55); margin-top: 2px; }

    /* â•â• STEPPER â€” named steps with dots and connecting lines â•â• */
    #stepper {
      background: #0f172a;
      padding: 14px 24px 18px;
      display: flex;
      align-items: flex-start;
    }

    .step-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      gap: 8px;
    }

    /* Connecting line: from center of this dot to center of next dot */
    .step-item:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 12px;          /* vertically aligned to center of 26px dot */
      left: 50%;
      width: 100%;
      height: 2px;
      background: rgba(255,255,255,0.1);
      transition: background 0.4s ease;
      z-index: 0;
    }
    .step-item.done::after { background: var(--c); }

    .step-dot {
      width: 26px; height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.06);
      border: 2px solid rgba(255,255,255,0.14);
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 800;
      color: rgba(255,255,255,0.28);
      position: relative; z-index: 1;
      transition: all 0.35s ease;
      flex-shrink: 0;
      cursor: default;
    }
    .step-item.active .step-dot {
      background: var(--c);
      border-color: var(--c);
      color: #fff;
      box-shadow: 0 0 0 4px rgba(255,255,255,0.12), 0 0 12px rgba(255,255,255,0.08);
    }
    .step-item.done .step-dot {
      background: var(--c);
      border-color: var(--c);
      color: #fff;
    }

    .step-name {
      font-size: 9.5px;
      font-weight: 600;
      color: rgba(255,255,255,0.22);
      text-align: center;
      letter-spacing: 0.2px;
      transition: color 0.3s ease;
      line-height: 1.3;
      max-width: 68px;
    }
    .step-item.active .step-name {
      color: rgba(255,255,255,0.92);
      font-weight: 700;
    }
    .step-item.done .step-name {
      color: rgba(255,255,255,0.48);
    }

    /* â•â• MESSAGES â•â• */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 20px 8px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }

    /* â”€â”€ Bubbles â”€â”€ */
    .msg {
      display: flex; gap: 10px;
      max-width: 88%;
      animation: fadeUp 0.2s ease;
    }
    @keyframes fadeUp {
      from { opacity:0; transform:translateY(8px); }
      to   { opacity:1; transform:none; }
    }
    .msg.user  { align-self: flex-end;   flex-direction: row-reverse; }
    .msg.agent { align-self: flex-start; }

    .avatar {
      width: 34px; height: 34px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; flex-shrink: 0; letter-spacing: 0.3px;
    }
    .msg.agent .avatar { background: #e8edf8; color: var(--stage-color); transition: color 0.3s; }
    .msg.user  .avatar { background: var(--stage-color); color: #fff; transition: background 0.3s; }

    .bubble {
      padding: 13px 17px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.65;
      word-break: break-word;
    }
    .msg.agent .bubble {
      background: #f8fafc;
      color: var(--text);
      border: 1px solid var(--border);
      border-top-left-radius: 4px;
    }
    .msg.user .bubble {
      background: var(--stage-color);
      color: #fff;
      border-top-right-radius: 4px;
      transition: background 0.3s;
    }
    .bubble h1 { font-size:18px; margin:0 0 8px; }
    .bubble h2 { font-size:16px; margin:10px 0 6px; }
    .bubble h3 { font-size:15px; margin:8px 0 4px; }
    .bubble strong { font-weight:700; }
    .bubble em { font-style:italic; color:#555; }
    .bubble ul { padding-left:18px; margin:6px 0; }
    .bubble li { margin:3px 0; }
    .bubble p  { margin:4px 0; }
    .msg.user .bubble em { color:rgba(255,255,255,0.8); }

    /* â”€â”€ Stage input card â”€â”€ */
    .stage-card {
      margin: 6px 0;
      border-radius: 14px;
      overflow: hidden;
      border: 1.5px solid var(--card-hex, #e2e8f0);
      animation: fadeUp 0.3s ease;
      align-self: stretch;
    }

    .stage-card-header {
      background: var(--card-hex, #e2e8f0);
      color: #fff;
      padding: 11px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stage-card-header .badge {
      background: rgba(255,255,255,0.25);
      border-radius: 20px;
      padding: 2px 10px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }
    .stage-card-header .stage-title { font-size: 15px; font-weight: 700; }

    .stage-card-body { background: #fff; padding: 14px 16px 16px; }

    .stage-desc {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.6;
    }

    /* â”€â”€ Field groups with pill labels â”€â”€ */
    .stage-form { display: flex; flex-direction: column; gap: 0; }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 9px;
      padding: 12px 0 4px;
      border-top: 1px solid var(--border);
    }
    .field-group:first-child {
      border-top: none;
      padding-top: 0;
    }

    .field-group-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 10.5px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.7px;
      padding: 3px 11px;
      border-radius: 20px;
      border: 1.5px solid;
      align-self: flex-start;
      margin-bottom: 2px;
      line-height: 1.4;
    }
    /* small dot icon inside pill */
    .field-group-pill::before {
      content: '';
      width: 5px; height: 5px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.7;
      flex-shrink: 0;
    }

    .group-fields {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-left: 2px;
    }

    /* â”€â”€ Individual field â”€â”€ */
    .form-field { display: flex; flex-direction: column; gap: 4px; }

    .form-field label {
      font-size: 12px;
      font-weight: 700;
      color: var(--card-hex, var(--muted));
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-field input,
    .form-field textarea {
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 9px 12px;
      font-size: 14px;
      font-family: inherit;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
      resize: vertical;
    }
    .form-field input:focus,
    .form-field textarea:focus {
      border-color: var(--card-hex, var(--stage-color));
    }
    .form-field textarea { min-height: 72px; }

    .stage-submit-btn {
      margin-top: 10px;
      background: var(--card-hex, var(--stage-color));
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      align-self: flex-start;
      transition: filter 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .stage-submit-btn:hover   { filter: brightness(0.9); }
    .stage-submit-btn:disabled { opacity: 0.5; cursor: default; filter: none; }

    .form-submitted {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 8px;
      font-size: 13px;
      color: #166534;
      font-weight: 600;
    }

    /* â”€â”€ Typing indicator â”€â”€ */
    .typing .bubble { padding:14px 18px; background:#f8fafc; border:1px solid var(--border); }
    .dots { display:flex; gap:5px; align-items:center; }
    .dots span {
      width:8px; height:8px; background:#94a3b8; border-radius:50%;
      animation:bounce 1.2s infinite;
    }
    .dots span:nth-child(2) { animation-delay:.2s; }
    .dots span:nth-child(3) { animation-delay:.4s; }
    @keyframes bounce {
      0%,60%,100%{ transform:translateY(0); }
      30%{ transform:translateY(-5px); }
    }

    /* â”€â”€ Complete banner â”€â”€ */
    #complete-banner {
      display: none;
      background: linear-gradient(135deg,#ecfdf5,#d1fae5);
      border-top: 2px solid var(--done);
      padding: 16px 20px;
      text-align: center;
    }
    #complete-banner p { font-size:14px; color:#065f46; margin-bottom:12px; font-weight:500; }
    #view-plan-btn {
      background: var(--done); color:#fff; border:none;
      padding:11px 32px; border-radius:8px;
      font-size:14px; font-weight:700; cursor:pointer;
      transition: filter .2s;
    }
    #view-plan-btn:hover { filter: brightness(0.9); }

    /* â”€â”€ Hint bar â”€â”€ */
    #hint-bar {
      background: #f8fafc;
      border-top: 1px solid var(--border);
      padding: 7px 18px;
      font-size: 12.5px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #hint-bar .dot { width:8px; height:8px; border-radius:50%; background:var(--stage-color); flex-shrink:0; transition:background .3s; }

    /* â”€â”€ Input row â”€â”€ */
    #input-area {
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex; gap:10px;
      background: var(--surface);
    }
    #user-input {
      flex:1; border:1.5px solid var(--border); border-radius:12px;
      padding:11px 15px; font-size:14.5px; resize:none; outline:none;
      font-family:inherit; max-height:130px; line-height:1.5; color:var(--text);
      transition:border-color .2s;
    }
    #user-input:focus { border-color: var(--stage-color); }
    #send-btn {
      background: var(--stage-color); color:#fff; border:none; border-radius:12px;
      width:44px; height:44px; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      align-self:flex-end; transition:background .3s, filter .2s; flex-shrink:0;
    }
    #send-btn:hover { filter:brightness(0.9); }
    #send-btn:disabled { background:#cbd5e1; cursor:default; filter:none; }
    #send-btn svg { width:18px; height:18px; }

    /* â•â• PLAN VIEW â•â• */
    #plan-view {
      display: none;
      width: 100%; max-width: 820px;
      height: 100vh;
      flex-direction: column;
      background: var(--surface);
      box-shadow: 0 4px 32px rgba(0,0,0,0.12);
    }
    #plan-header {
      background: #0f172a; color:#fff;
      padding:18px 24px;
      display:flex; align-items:center; justify-content:space-between;
    }
    #plan-header h2 { font-size:17px; font-weight:700; }
    .plan-actions { display:flex; gap:10px; }
    .plan-btn {
      color:#fff; border:none; padding:8px 18px; border-radius:7px;
      font-size:13px; font-weight:600; cursor:pointer; transition:filter .2s;
    }
    .plan-btn:hover { filter:brightness(0.9); }
    #btn-back     { background:#334155; }
    #btn-download { background:var(--done); }

    #plan-body { flex:1; overflow-y:auto; padding:32px 36px; }

    #plan-body h1 { font-size:26px; font-weight:800; color:var(--text); margin-bottom:6px; }
    #plan-body .plan-meta { display:flex; flex-wrap:wrap; gap:10px; margin:12px 0 24px; }
    #plan-body .meta-chip {
      background:#f1f5f9; border-radius:20px;
      padding:4px 14px; font-size:13px; color:var(--muted); border:1px solid var(--border);
    }
    #plan-body hr { border:none; border-top:2px solid var(--border); margin:28px 0; }
    #plan-body .section-header { display:flex; align-items:center; gap:10px; margin:28px 0 14px; }
    #plan-body .section-pill {
      border-radius:6px; padding:4px 14px;
      font-size:12px; font-weight:800; letter-spacing:.8px; text-transform:uppercase; color:#fff;
    }
    #plan-body .section-title { font-size:19px; font-weight:700; color:var(--text); }
    #plan-body h3 {
      font-size:13px; color:var(--muted); font-weight:700;
      margin:18px 0 8px; text-transform:uppercase; letter-spacing:.5px;
    }
    #plan-body ul { padding-left:0; list-style:none; margin:6px 0 14px; }
    #plan-body li {
      padding:9px 14px; margin:5px 0;
      border-radius:8px; font-size:14px; line-height:1.6; color:var(--text);
      border-left:3px solid var(--border); background:#f8fafc;
    }
    #plan-body strong { font-weight:700; }
    #plan-body em { font-style:italic; color:var(--muted); }
    .risk-high   { border-left-color:var(--s5) !important; }
    .risk-medium { border-left-color:var(--s4) !important; }
    .risk-low    { border-left-color:var(--done) !important; }
  </style>
</head>
<body>

<!-- â•â• CHAT VIEW â•â• -->
<div id="chat-view">
  <div id="chat-header">
    <div class="header-logo">P</div>
    <div class="header-info">
      <h1>Project Planning Agent</h1>
      <p>5-stage AI-powered project planner</p>
    </div>
  </div>

  <!-- Named stepper: dots + connecting lines + always-visible labels -->
  <div id="stepper">
    <div class="step-item active" style="--c:#3b82f6">
      <div class="step-dot" id="dot-1">1</div>
      <div class="step-name">Goal &amp; Vision</div>
    </div>
    <div class="step-item" style="--c:#8b5cf6">
      <div class="step-dot" id="dot-2">2</div>
      <div class="step-name">Budget &amp; Team</div>
    </div>
    <div class="step-item" style="--c:#06b6d4">
      <div class="step-dot" id="dot-3">3</div>
      <div class="step-name">Phases</div>
    </div>
    <div class="step-item" style="--c:#f59e0b">
      <div class="step-dot" id="dot-4">4</div>
      <div class="step-name">Task Plan</div>
    </div>
    <div class="step-item" style="--c:#ef4444">
      <div class="step-dot" id="dot-5">5</div>
      <div class="step-name">Risk &amp; Review</div>
    </div>
  </div>

  <div id="messages"></div>

  <div id="complete-banner">
    <p>ğŸ‰ All 5 stages complete â€” your structured project plan is ready!</p>
    <button id="view-plan-btn" onclick="showPlan()">View Project Plan â†’</button>
  </div>

  <div id="hint-bar">
    <span class="dot" id="hint-dot"></span>
    <span id="hint-text">Fill in the form above or type freely below.</span>
  </div>

  <div id="input-area">
    <textarea id="user-input" rows="1"
      placeholder="Or type freely here and press Enterâ€¦"></textarea>
    <button id="send-btn" onclick="sendMessage()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
           stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/>
        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
</div>

<!-- â•â• PLAN VIEW â•â• -->
<div id="plan-view">
  <div id="plan-header">
    <h2>ğŸ“‹ Your Project Plan</h2>
    <div class="plan-actions">
      <button class="plan-btn" id="btn-back"     onclick="backToChat()">â† Back</button>
      <button class="plan-btn" id="btn-download" onclick="downloadPlan()">Download .md</button>
    </div>
  </div>
  <div id="plan-body"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAGE CONFIG â€” with grouped field pills
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STAGE_CONFIG = {
  define_outcome: {
    num: 1, hex: "#3b82f6",
    title: "Define Outcome",
    desc: "Tell us what you are building, who it is for, and what success looks like.",
    // Groups: each group gets a colored pill header
    groups: [
      {
        label: "Project Identity",
        fields: [
          { key:"project_name", label:"Project name", placeholder:"e.g. Koru App", type:"input" },
        ]
      },
      {
        label: "Audience & Purpose",
        fields: [
          { key:"audience", label:"Who is it for?",  placeholder:"e.g. adults managing workplace stress",      type:"input" },
          { key:"purpose",  label:"Core purpose",    placeholder:"e.g. guided meditation and breathing tools", type:"input" },
        ]
      },
      {
        label: "Success Criteria",
        fields: [
          { key:"success_metric", label:"What does success look like?", placeholder:"e.g. 1,000 active users within 3 months of launch", type:"input" },
        ]
      },
    ],
    assemble: f => `Project name: ${f.project_name}. It is for: ${f.audience}. Core purpose: ${f.purpose}. Success means: ${f.success_metric}.`
  },

  strategic_constraints: {
    num: 2, hex: "#8b5cf6",
    title: "Strategic Constraints",
    desc: "Share the practical limits that will shape the plan.",
    groups: [
      {
        label: "Timeline",
        fields: [
          { key:"deadline", label:"Deadline", placeholder:"e.g. end of Q4 2026", type:"input" },
        ]
      },
      {
        label: "Resources",
        fields: [
          { key:"budget",    label:"Budget",            placeholder:"e.g. $50,000 or TBD",                       type:"input" },
          { key:"team_size", label:"Team size & roles",  placeholder:"e.g. 3 engineers, 1 PM, 1 designer",       type:"input" },
        ]
      },
      {
        label: "Process",
        fields: [
          { key:"methodology", label:"Methodology", placeholder:"e.g. Agile, Waterfall, Hybrid, no preference", type:"input" },
        ]
      },
    ],
    assemble: f => `Deadline: ${f.deadline}. Budget: ${f.budget}. Team: ${f.team_size}. Methodology: ${f.methodology}.`
  },

  phases_and_milestones: {
    num: 3, hex: "#06b6d4",
    title: "Phases & Milestones",
    desc: "Break the project into major phases and name the key deliverable for each.",
    groups: [
      {
        label: "Phase Structure",
        fields: [
          { key:"phases",   label:"Major phases (comma-separated)", placeholder:"e.g. Discovery, Design, Build, Launch",  type:"input" },
          { key:"timeline", label:"Overall timeline",               placeholder:"e.g. 6 months total, Janâ€“Jun 2026",      type:"input" },
        ]
      },
      {
        label: "Key Deliverables",
        fields: [
          { key:"milestone_1", label:"Deliverable for Phase 1", placeholder:"e.g. Approved requirements document", type:"input" },
          { key:"milestone_2", label:"Deliverable for Phase 2", placeholder:"e.g. Signed-off design mockups",      type:"input" },
        ]
      },
    ],
    assemble: f => `Phases: ${f.phases}. Phase 1 deliverable: ${f.milestone_1}. Phase 2 deliverable: ${f.milestone_2}. Timeline: ${f.timeline}.`
  },

  tasks_and_subtasks: {
    num: 4, hex: "#f59e0b",
    title: "Tasks & Subtasks",
    desc: "For each phase, list the work items, owners, and how long they take.",
    groups: [
      {
        label: "Phase Focus",
        fields: [
          { key:"phase_focus", label:"Which phase are we breaking down?", placeholder:"e.g. Discovery", type:"input" },
        ]
      },
      {
        label: "Work Items",
        fields: [
          { key:"tasks", label:"Main tasks (one per line)", placeholder:"e.g.\nStakeholder interviews\nCompetitor analysis\nTechnical scoping", type:"textarea" },
        ]
      },
      {
        label: "Ownership & Duration",
        fields: [
          { key:"owners",    label:"Who owns each task?",   placeholder:"e.g. PM owns interviews, Engineer owns scoping",  type:"input" },
          { key:"durations", label:"Estimated durations",   placeholder:"e.g. interviews: 3 days, scoping: 5 days",        type:"input" },
        ]
      },
    ],
    assemble: f => `Phase: ${f.phase_focus}. Tasks: ${f.tasks.replace(/\n/g,', ')}. Owners: ${f.owners}. Durations: ${f.durations}.`
  },

  risk_and_governance: {
    num: 5, hex: "#ef4444",
    title: "Risk & Governance",
    desc: "Identify what could go wrong and how the project will be monitored.",
    groups: [
      {
        label: "Key Risks",
        fields: [
          { key:"risks", label:"Risks (one per line)", placeholder:"e.g.\nKey engineer leaves\nScope creep\nThird-party delays", type:"textarea" },
        ]
      },
      {
        label: "Stakeholders",
        fields: [
          { key:"stakeholders", label:"Stakeholders", placeholder:"e.g. CEO, CTO, Head of Product", type:"input" },
        ]
      },
      {
        label: "Measurement & Cadence",
        fields: [
          { key:"kpis",           label:"Success KPIs",    placeholder:"e.g. 1,000 MAU, 4.5+ app store rating",          type:"input" },
          { key:"review_cadence", label:"Review cadence",  placeholder:"e.g. weekly standup, monthly steering committee", type:"input" },
        ]
      },
    ],
    assemble: f => `Risks: ${f.risks.replace(/\n/g,'; ')}. Stakeholders: ${f.stakeholders}. KPIs: ${f.kpis}. Review cadence: ${f.review_cadence}.`
  },

  complete: { num:6, hex:"#10b981", title:"Complete", desc:"", groups:[], assemble:()=>"" }
};

// Flat fields array derived from groups (for backward-compat with submitStageForm)
Object.values(STAGE_CONFIG).forEach(cfg => {
  if (cfg.groups) {
    cfg.fields = cfg.groups.flatMap(g => g.fields || []);
  } else {
    cfg.fields = cfg.fields || [];
  }
});

const STAGE_ORDER = [
  "define_outcome","strategic_constraints","phases_and_milestones",
  "tasks_and_subtasks","risk_and_governance","complete"
];

const HINTS = {
  define_outcome:        "Stage 1 â€” Fill in the form or type freely to describe your project and success goal.",
  strategic_constraints: "Stage 2 â€” Share your deadline, budget, team size, and methodology.",
  phases_and_milestones: "Stage 3 â€” Describe the major phases and key deliverable for each.",
  tasks_and_subtasks:    "Stage 4 â€” For each phase, list tasks, owners, and durations.",
  risk_and_governance:   "Stage 5 â€” Share key risks, stakeholders, KPIs, and review cadence.",
  complete:              "Planning complete â€” view your structured project plan above."
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sessionId    = null;
let planMarkdown = "";
let currentStage = "define_outcome";

const messagesEl     = document.getElementById("messages");
const inputEl        = document.getElementById("user-input");
const sendBtn        = document.getElementById("send-btn");
const hintDot        = document.getElementById("hint-dot");
const hintText       = document.getElementById("hint-text");
const completeBanner = document.getElementById("complete-banner");

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
inputEl.addEventListener("input", () => {
  inputEl.style.height = "auto";
  inputEl.style.height = Math.min(inputEl.scrollHeight, 130) + "px";
});
inputEl.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  if (!s) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// Mix hex color with white to produce a lighter tint
function lightenHex(hex, t = 0.88) {
  const r = parseInt(hex.slice(1,3), 16);
  const g = parseInt(hex.slice(3,5), 16);
  const b = parseInt(hex.slice(5,7), 16);
  return `rgb(${Math.round(r+(255-r)*t)},${Math.round(g+(255-g)*t)},${Math.round(b+(255-b)*t)})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKDOWN â†’ SAFE HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function md(text) {
  return text
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")
    .replace(/_(.*?)_/g,"<em>$1</em>")
    .replace(/\*(.*?)\*/g,"<em>$1</em>")
    .replace(/^### (.+)$/gm,"<h3>$1</h3>")
    .replace(/^## (.+)$/gm,"<h2>$1</h2>")
    .replace(/^# (.+)$/gm,"<h1>$1</h1>")
    .replace(/^---$/gm,"<hr>")
    .replace(/^- (.+)$/gm,"<li>$1</li>")
    .replace(/(<li>[\s\S]*?<\/li>)/g,"<ul>$1</ul>")
    .replace(/\n{2,}/g,"<br><br>")
    .replace(/\n/g,"<br>");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAGE INPUT CARD â€” grouped with pill labels
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function insertStageCard(stageKey) {
  const cfg = STAGE_CONFIG[stageKey];
  if (!cfg || !cfg.groups || !cfg.groups.length) return;

  const cardId = "card-" + stageKey;
  if (document.getElementById(cardId)) return;

  const card = document.createElement("div");
  card.className = "stage-card";
  card.id = cardId;
  card.style.setProperty("--card-hex", cfg.hex);

  // Compute pill colors from stage hex
  const pillBg     = lightenHex(cfg.hex, 0.88);
  const pillBorder = cfg.hex;
  const pillColor  = cfg.hex;

  // Build grouped form HTML
  let groupsHtml = "";
  cfg.groups.forEach(g => {
    let fieldsHtml = "";
    g.fields.forEach(f => {
      const inputHtml = f.type === "textarea"
        ? `<textarea id="f_${stageKey}_${f.key}" placeholder="${esc(f.placeholder)}"></textarea>`
        : `<input    id="f_${stageKey}_${f.key}" type="text" placeholder="${esc(f.placeholder)}" />`;
      fieldsHtml += `
        <div class="form-field">
          <label for="f_${stageKey}_${f.key}">${esc(f.label)}</label>
          ${inputHtml}
        </div>`;
    });

    groupsHtml += `
      <div class="field-group">
        <span class="field-group-pill"
              style="background:${pillBg}; border-color:${pillBorder}; color:${pillColor}">
          ${esc(g.label)}
        </span>
        <div class="group-fields">${fieldsHtml}</div>
      </div>`;
  });

  card.innerHTML = `
    <div class="stage-card-header">
      <span class="badge">Stage ${cfg.num}</span>
      <span class="stage-title">${cfg.title}</span>
    </div>
    <div class="stage-card-body">
      <p class="stage-desc">${cfg.desc}</p>
      <div class="stage-form" id="form-${stageKey}">
        ${groupsHtml}
        <button class="stage-submit-btn" id="submit-${stageKey}"
                onclick="submitStageForm('${stageKey}')">
          Send to Agent â†’
        </button>
      </div>
      <div class="form-submitted" id="submitted-${stageKey}">
        âœ“ Submitted â€” see the agent's response above
      </div>
    </div>`;

  messagesEl.appendChild(card);
  // Scroll to show the TOP of the card â€” user fills top-to-bottom and scrolls naturally to the button
  setTimeout(() => {
    const newCard = document.getElementById(cardId);
    if (newCard) newCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 80);
}

function submitStageForm(stageKey) {
  const cfg = STAGE_CONFIG[stageKey];
  const values = {};

  cfg.fields.forEach(f => {
    const el = document.getElementById(`f_${stageKey}_${f.key}`);
    values[f.key] = (el ? el.value.trim() : "") || "(not specified)";
  });

  const message = cfg.assemble(values);

  const form      = document.getElementById(`form-${stageKey}`);
  const submitted = document.getElementById(`submitted-${stageKey}`);
  if (form)      form.style.display      = "none";
  if (submitted) submitted.style.display = "flex";

  sendMessageText(message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUBBLE + STAGE TRANSITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addAgentTurn(text) {
  const parts      = text.split("\n\n---\n");
  const replyText  = parts[0].trim();
  const dividerText = parts[1] ? parts[1].trim() : null;

  appendBubble("agent", replyText);

  if (dividerText) {
    const nextStageKey = Object.keys(STAGE_CONFIG).find(k => {
      const cfg = STAGE_CONFIG[k];
      return cfg.title && dividerText.toLowerCase().includes(cfg.title.toLowerCase());
    });
    if (nextStageKey) insertStageCard(nextStageKey);
  }
}

function appendBubble(role, text) {
  const wrap = document.createElement("div");
  wrap.className = `msg ${role}`;

  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = role === "user" ? "You" : "AI";

  const bub = document.createElement("div");
  bub.className = "bubble";
  bub.innerHTML = md(text);

  wrap.appendChild(av);
  wrap.appendChild(bub);
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function showTyping() {
  const wrap = document.createElement("div");
  wrap.className = "msg agent typing";
  wrap.id = "typing";

  const av = document.createElement("div");
  av.className = "avatar"; av.textContent = "AI";

  const bub = document.createElement("div");
  bub.className = "bubble";
  bub.innerHTML = `<div class="dots"><span></span><span></span><span></span></div>`;

  wrap.appendChild(av); wrap.appendChild(bub);
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById("typing");
  if (t) t.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS STEPPER â€” named steps with dots
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateProgress(stageValue) {
  currentStage = stageValue;
  const cfg = STAGE_CONFIG[stageValue] || STAGE_CONFIG.define_outcome;
  const idx = STAGE_ORDER.indexOf(stageValue);

  // Update global stage color CSS variable
  document.documentElement.style.setProperty('--stage-color', cfg.hex);

  // Update each step-item
  const stepItems = document.querySelectorAll(".step-item");
  stepItems.forEach((item, i) => {
    const isDone   = i < idx;
    const isActive = i === idx;
    item.classList.toggle("done",   isDone);
    item.classList.toggle("active", isActive);

    // Show âœ“ for completed steps, number for others
    const dot = item.querySelector(".step-dot");
    if (dot) dot.textContent = isDone ? "âœ“" : String(i + 1);
  });

  hintText.textContent = HINTS[stageValue] || "";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEND (two entry points)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendMessage() {
  const text = inputEl.value.trim();
  if (!text) return;
  inputEl.value = "";
  inputEl.style.height = "auto";
  sendMessageText(text);
}

async function sendMessageText(text) {
  if (!text || sendBtn.disabled) return;

  appendBubble("user", text);
  sendBtn.disabled = true;
  showTyping();

  try {
    const body = { message: text };
    if (sessionId) body.session_id = sessionId;

    const res = await fetch("/api/v1/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    removeTyping();

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      appendBubble("agent", `âš ï¸ ${err.detail || "Something went wrong. Please try again."}`);
      sendBtn.disabled = false;
      return;
    }

    const data = await res.json();
    sessionId = data.session_id;

    updateProgress(data.current_stage);
    addAgentTurn(data.reply);

    if (data.is_complete) {
      completeBanner.style.display = "block";
      inputEl.disabled = true;
      inputEl.placeholder = "Planning complete â€” click 'View Project Plan' above.";
    } else {
      sendBtn.disabled = false;
      inputEl.focus();
    }

  } catch {
    removeTyping();
    appendBubble("agent", "âš ï¸ Could not reach the server. Is it running?");
    sendBtn.disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAN VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showPlan() {
  if (!sessionId) return;
  const res = await fetch(`/api/v1/session/${sessionId}/plan`);
  if (!res.ok) { alert("Could not load plan."); return; }
  const data = await res.json();
  planMarkdown = data.plan_markdown;
  renderPlan(data.plan_json);
  document.getElementById("chat-view").style.display = "none";
  document.getElementById("plan-view").style.display  = "flex";
}

function renderPlan(plan) {
  const body = document.getElementById("plan-body");
  let html = "";

  html += `<h1>${esc(plan.project_name)}</h1>`;
  html += `<div class="plan-meta">`;
  if (plan.deadline)    html += `<span class="meta-chip">ğŸ“… ${esc(plan.deadline)}</span>`;
  if (plan.budget)      html += `<span class="meta-chip">ğŸ’° ${esc(plan.budget)}</span>`;
  if (plan.team_size)   html += `<span class="meta-chip">ğŸ‘¥ ${plan.team_size} people</span>`;
  if (plan.methodology) html += `<span class="meta-chip">âš™ï¸ ${esc(plan.methodology)}</span>`;
  html += `</div>`;
  html += `<p style="color:var(--muted);font-size:14px;margin-bottom:20px">${esc(plan.success_definition)}</p>`;
  html += `<hr>`;

  const milestones = plan.project_type === "program"
    ? (plan.pillars||[]).flatMap(p=>p.milestones||[])
    : (plan.milestones||[]);

  if (milestones.length) {
    html += `<div class="section-header">
      <span class="section-pill" style="background:#06b6d4">Project Plan</span>
    </div>`;
    milestones.forEach(ms => {
      html += `<h3>${esc(ms.name)}</h3>`;
      if (ms.deliverable) html += `<p style="font-size:13px;color:var(--muted);margin-bottom:8px">Deliverable: ${esc(ms.deliverable)}</p>`;
      if (ms.tasks && ms.tasks.length) {
        html += `<ul>`;
        ms.tasks.forEach(t => {
          const meta = [t.owner && `Owner: ${esc(t.owner)}`, t.duration_days && `${t.duration_days}d`].filter(Boolean).join(" Â· ");
          html += `<li style="border-left-color:#06b6d4"><strong>${esc(t.name)}</strong>${meta ? ` <em style="font-weight:400;font-size:12px"> â€” ${meta}</em>` : ""}`;
          if (t.subtasks && t.subtasks.length) {
            html += `<ul style="margin-top:6px">`;
            t.subtasks.forEach(st => {
              const stm = [st.owner && esc(st.owner), st.timeline && esc(st.timeline)].filter(Boolean).join(", ");
              html += `<li style="background:#f1f5f9;border-left-color:#f59e0b">${esc(st.name)}${stm ? ` <em>â€” ${stm}</em>` : ""}</li>`;
            });
            html += `</ul>`;
          }
          html += `</li>`;
        });
        html += `</ul>`;
      }
    });
  }

  const gov = plan.governance;
  if (gov) {
    html += `<hr>`;
    html += `<div class="section-header">
      <span class="section-pill" style="background:#ef4444">Governance &amp; Risk</span>
    </div>`;
    if (gov.stakeholders && gov.stakeholders.length) {
      html += `<h3>Stakeholders</h3><ul>`;
      gov.stakeholders.forEach(s => html += `<li style="border-left-color:#8b5cf6">${esc(s)}</li>`);
      html += `</ul>`;
    }
    if (gov.kpis && gov.kpis.length) {
      html += `<h3>KPIs</h3><ul>`;
      gov.kpis.forEach(k => {
        const t = k.target ? ` â€” Target: ${esc(k.target)}` : "";
        html += `<li style="border-left-color:#3b82f6"><strong>${esc(k.metric)}</strong>${t}</li>`;
      });
      html += `</ul>`;
    }
    if (gov.risks && gov.risks.length) {
      html += `<h3>Risks</h3><ul>`;
      gov.risks.forEach(r => {
        const sev = (r.severity||"").toLowerCase();
        const cls = sev==="high" ? "risk-high" : sev==="medium" ? "risk-medium" : "risk-low";
        const bg  = sev==="high" ? "#ef4444" : sev==="medium" ? "#f59e0b" : "#10b981";
        const badge = `<span style="background:${bg};color:#fff;border-radius:4px;padding:1px 7px;font-size:11px;font-weight:700;margin-right:6px">${sev.toUpperCase()}</span>`;
        html += `<li class="${cls}">${badge}${esc(r.description)}${r.mitigation ? `<br><em style="font-size:12.5px">Mitigation: ${esc(r.mitigation)}</em>` : ""}</li>`;
      });
      html += `</ul>`;
    }
    if (gov.external_vendors && gov.external_vendors.length) {
      html += `<h3>External Vendors</h3><ul>`;
      gov.external_vendors.forEach(v => html += `<li style="border-left-color:var(--muted)">${esc(v)}</li>`);
      html += `</ul>`;
    }
    if (gov.review_cadence) {
      html += `<h3>Review Cadence</h3><p style="font-size:14px;margin:4px 0 12px">${esc(gov.review_cadence)}</p>`;
    }
  }

  body.innerHTML = html;
}

function backToChat() {
  document.getElementById("plan-view").style.display  = "none";
  document.getElementById("chat-view").style.display = "flex";
}

function downloadPlan() {
  const blob = new Blob([planMarkdown],{type:"text/markdown"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href=url; a.download="project-plan.md"; a.click();
  URL.revokeObjectURL(url);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener("load", () => {
  updateProgress("define_outcome");

  appendBubble("agent",
    "I am your **Project Planning Agent**.\n\n" +
    "I will guide you through **5 structured stages** to build a complete, actionable project plan â€” " +
    "covering outcomes, constraints, phases, tasks, and risks.\n\n" +
    "Fill in the form below and click **Send to Agent**, or type freely in the text box."
  );

  insertStageCard("define_outcome");
  inputEl.focus();
});
</script>
</body>
</html>
